{% extends "layout.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 fw-bold mb-0">User Directory</h1>
        <p class="text-muted">View and manage all registered students and teachers.</p>
    </div>
    <div class="d-flex gap-2">
        <div class="input-group">
            <span class="input-group-text border-end-0"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control border-start-0 ps-0" id="searchInput" placeholder="Search users...">
        </div>
        <button class="btn btn-primary text-nowrap" data-bs-toggle="modal" data-bs-target="#addUserModal">
            <i class="bi bi-plus-lg"></i> Add User
        </button>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header py-3">
        <ul class="nav nav-pills card-header-pills" id="userTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab">All Users</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="students-tab" data-bs-toggle="tab" data-bs-target="#students" type="button" role="tab">Students</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="teachers-tab" data-bs-toggle="tab" data-bs-target="#teachers" type="button" role="tab">Teachers</button>
            </li>
        </ul>
    </div>
    <div class="card-body p-0">
        <div class="tab-content" id="userTabsContent">
            <!-- All Users Tab -->
            <div class="tab-pane fade show active" id="all" role="tabpanel">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle" id="usersTable">
                        <thead class="text-secondary">
                            <tr>
                                <th class="ps-4">ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Joined</th>
                                <th>Courses</th>
                                <th class="text-end pe-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr class="user-row">
                                <td class="ps-4 text-muted">#{{ user.id }}</td>
                                <td class="fw-semibold">{{ user.name }}</td>
                                <td>{{ user.email }}</td>
                                <td>
                                    {% if user.role.value == 'student' %}
                                        <span class="badge bg-info text-dark">Student</span>
                                    {% elif user.role.value == 'teacher' %}
                                        <span class="badge bg-success">Teacher</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ user.role.value }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-muted small">
                                    {{ user.created_at.strftime('%Y-%m-%d') if user.created_at else 'N/A' }}
                                </td>
                                <td>
                                    {% if user.role.value == 'student' %}
                                        {% for course in user.enrolled_courses %}
                                            <span class="badge border text-body-secondary">{{ course.code }}</span>
                                        {% else %}
                                            <span class="text-muted small">-</span>
                                        {% endfor %}
                                    {% elif user.role.value == 'teacher' %}
                                        {% for course in user.teaching_courses %}
                                            <span class="badge border text-body-secondary">{{ course.code }}</span>
                                        {% else %}
                                            <span class="text-muted small">-</span>
                                        {% endfor %}
                                    {% else %}
                                        <span class="text-muted small">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-end pe-4">
                                    <button class="btn btn-sm btn-outline-secondary edit-btn" 
                                            data-id="{{ user.id }}" 
                                            data-name="{{ user.name }}" 
                                            data-email="{{ user.email }}" 
                                            data-role="{{ user.role.value }}">
                                        Edit
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger ms-1 delete-btn" data-id="{{ user.id }}">Delete</button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="7" class="text-center py-5">
                                    <p class="text-muted mb-0">No users found.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Other tabs are just simplified views, for full CRUD we usually focus on the main table or replicate logic. 
                 For simplicity in this demo, I will keep them read-only or just hide them if we want a single source of truth.
                 Let's keep them as read-only subsets for now to avoid ID conflict complexities in the DOM. -->
            <div class="tab-pane fade" id="students" role="tabpanel">
                 <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="text-secondary">
                            <tr>
                                <th class="ps-4">ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Enrolled Courses</th>
                                <th class="text-end pe-4">Joined</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users if user.role.value == 'student' %}
                            <tr>
                                <td class="ps-4 text-muted">#{{ user.id }}</td>
                                <td class="fw-semibold">{{ user.name }}</td>
                                <td>{{ user.email }}</td>
                                <td>
                                    {% for course in user.enrolled_courses %}
                                        <span class="badge border text-body-secondary">{{ course.code }}</span>
                                    {% else %}
                                        <span class="text-muted small">-</span>
                                    {% endfor %}
                                </td>
                                <td class="text-end pe-4 text-muted small">
                                    {{ user.created_at.strftime('%Y-%m-%d') if user.created_at else 'N/A' }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="teachers" role="tabpanel">
                 <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="text-secondary">
                            <tr>
                                <th class="ps-4">ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Teaching Courses</th>
                                <th class="text-end pe-4">Joined</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users if user.role.value == 'teacher' %}
                            <tr>
                                <td class="ps-4 text-muted">#{{ user.id }}</td>
                                <td class="fw-semibold">{{ user.name }}</td>
                                <td>{{ user.email }}</td>
                                <td>
                                    {% for course in user.teaching_courses %}
                                        <span class="badge border text-body-secondary">{{ course.code }}</span>
                                    {% else %}
                                        <span class="text-muted small">-</span>
                                    {% endfor %}
                                </td>
                                <td class="text-end pe-4 text-muted small">
                                    {{ user.created_at.strftime('%Y-%m-%d') if user.created_at else 'N/A' }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addUserForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-control" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" name="password" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <select class="form-select" name="role">
                            <option value="student">Student</option>
                            <option value="teacher">Teacher</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary px-4">Create User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editUserForm">
                <input type="hidden" name="id" id="editUserId">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control" name="name" id="editUserName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-control" name="email" id="editUserEmail" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <select class="form-select" name="role" id="editUserRole">
                            <option value="student">Student</option>
                            <option value="teacher">Teacher</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small">Leave password blank to keep current</label>
                        <input type="password" class="form-control" name="password" placeholder="New Password">
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary px-4">Update User</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<script>
    // --- Create User ---
    document.getElementById('addUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        try {
            const response = await fetch('/users/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (response.ok) {
                location.reload();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.error || 'Failed to create user'));
            }
        } catch (err) {
            console.error(err);
            alert('Something went wrong!');
        }
    });

    // --- Edit User Setup ---
    const editModal = new bootstrap.Modal(document.getElementById('editUserModal'));
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.getElementById('editUserId').value = btn.dataset.id;
            document.getElementById('editUserName').value = btn.dataset.name;
            document.getElementById('editUserEmail').value = btn.dataset.email;
            document.getElementById('editUserRole').value = btn.dataset.role;
            editModal.show();
        });
    });

    // --- Edit User Submit ---
    document.getElementById('editUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        const userId = data.id;
        
        // Remove empty password so it doesn't get hashed as empty string
        if (!data.password) delete data.password;
        
        try {
            const response = await fetch(`/users/${userId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (response.ok) {
                location.reload();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.error || 'Failed to update user'));
            }
        } catch (err) {
            console.error(err);
            alert('Something went wrong!');
        }
    });

    // --- Delete User ---
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            if (!confirm('Are you sure you want to delete this user?')) return;
            
            const userId = btn.dataset.id;
            try {
                const response = await fetch(`/users/${userId}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    location.reload(); // Simplest way to refresh table
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to delete user'));
                }
            } catch (err) {
                console.error(err);
                alert('Something went wrong!');
            }
        });
    });

    // --- Search Users (Debounced or on Enter) ---
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('keypress', async (e) => {
        if (e.key === 'Enter') {
            const query = searchInput.value;
            if (!query) {
                location.reload();
                return;
            }

            try {
                const response = await fetch(`/users/search?q=${query}`);
                if (response.ok) {
                    const users = await response.json();
                    updateTable(users);
                } else {
                    // 404 means no users found
                     const tbody = document.querySelector('#usersTable tbody');
                     tbody.innerHTML = `<tr><td colspan="6" class="text-center py-5"><p class="text-muted mb-0">No users found matching "${query}".</p></td></tr>`;
                }
            } catch (err) {
                console.error(err);
            }
        }
    });

    function updateTable(users) {
        const tbody = document.querySelector('#usersTable tbody');
        tbody.innerHTML = ''; // Clear current rows
        
        users.forEach(user => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="ps-4 text-muted">#${user.id}</td>
                <td class="fw-semibold">${user.name}</td>
                <td>${user.email}</td>
                <td>
                    ${user.role === 'student' ? '<span class="badge bg-info text-dark">Student</span>' : 
                      user.role === 'teacher' ? '<span class="badge bg-success">Teacher</span>' : 
                      '<span class="badge bg-secondary">' + user.role + '</span>'}
                </td>
                <td class="text-muted small">N/A</td> <!-- Search API might not return created_at, handle gracefully -->
                <td class="text-end pe-4">
                    <button class="btn btn-sm btn-outline-secondary edit-btn" 
                            data-id="${user.id}" 
                            data-name="${user.name}" 
                            data-email="${user.email}" 
                            data-role="${user.role}">
                        Edit
                    </button>
                    <button class="btn btn-sm btn-outline-danger ms-1 delete-btn" data-id="${user.id}">Delete</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        // Re-attach event listeners to new buttons
        // (For a robust app, we'd use event delegation, but this is a quick prototype fix)
        // Refreshing page is easier, but here we dynamically updated.
        // Let's just alert the user to reload for full functionality if they want to edit searched results, 
        // OR re-bind. I'll re-bind quickly.
        rebindEvents();
    }

    function rebindEvents() {
        // Re-bind Edit
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.getElementById('editUserId').value = btn.dataset.id;
                document.getElementById('editUserName').value = btn.dataset.name;
                document.getElementById('editUserEmail').value = btn.dataset.email;
                document.getElementById('editUserRole').value = btn.dataset.role;
                editModal.show();
            });
        });

        // Re-bind Delete
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                if (!confirm('Are you sure you want to delete this user?')) return;
                const userId = btn.dataset.id;
                try {
                    const response = await fetch(`/users/${userId}`, { method: 'DELETE' });
                    if (response.ok) {
                         // Remove row visually
                         btn.closest('tr').remove();
                    } else {
                        alert('Error deleting user');
                    }
                } catch (err) { console.error(err); }
            });
        });
    }

</script>
{% endblock %}